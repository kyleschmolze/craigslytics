<div class="row-fluid">
  <div class="span6">
    <h3>Overview</h3>
    <p>
      There are <strong><%= segment.listings.count %> similar listings</strong>. 
      You can see them on the map.<br>
      Here are a few quick facts about these listings:
    </p>
    <table class='table'>
      <tr>
        <td> Number of listings </td>
        <td> <%= segment.listings.count %> </td>
      </tr>
      <tr>
        <td> Lowest price </td>
        <td> $<%= segment.min_price %> / month </td>
      </tr>
      <tr>
        <td> Median price </td>
        <td> $<%= segment.median %> / month </td>
      </tr>
      <tr>
        <td> Highest price </td>
        <td> $<%= segment.max_price %> / month </td>
      </tr>
    </table>
  </div>
  <div class="span6">
    <h3>Location</h3>
    <p>
      <%= geocoded_address.formatted_address if geocoded_address.present? %>
    </p>
    <div id="map_canvas_<%= segment.unique_id %>" style="height:300px;text-align:center;">
      <%= image_tag 'loading.gif' %>
    </div>
  </div>
</div>

<br>
<br>

<div class="row-fluid">
  <div class="span6">
    <h3>Price Distribution</h3>
    <p>
      This graph shows the distribution of prices for these listings.
      Each bar represents a price range, and the size of the bar tells you how many
      listings we found inside that range.
    </p>
    <div id="chart_div_<%= segment.unique_id %>" style="height:400px;text-align:center;">
      <%= image_tag 'loading.gif' %>
    </div>
  </div>
  <div class="span6">
    <h3>Utilities Analysis</h3>
    <table class='table'>
      <% for utility in Tag.where(category: "utility") do %>
        <tr>
          <td> Median Price without <%= utility.display %>: <%= utilities["without_#{utility.search_term}"] %></td>
          <td> Median Price with <%= utility.display %>: <%= utilities["with_#{utility.search_term}"] %></td>
        </tr>
      <% end %>
    </table>
  </div>
</div>

<br>
<br>
  
<!-- Google Charts -->
<script type="text/javascript">
  google.load("visualization", "1", {packages:["corechart"]});
  google.setOnLoadCallback(drawChart);

  function drawChart() {
    var data = google.visualization.arrayToDataTable([
        ['Price', 'Listings'],
        <% (segment.adjusted_min..segment.adjusted_max+1).step(segment.increment) do |i| %>
        ["<%= "$#{i} - $#{i+segment.increment-1}" %>", <%= segment.listings.where("price >= ? AND price < ?", i, i+segment.increment).count %>],
        <% end %>
        ]);

    var options = {
      title: 'Number of Listings by Price Range',
      hAxis: {title: 'Number of Listings', showTextEvery: 1},
      vAxis: {title: 'Price Range', showTextEvery: 1},
      legend: {position: 'none'},
      chartArea:{top:"5%", height:"85%"}
    };

    var chart = new google.visualization.BarChart(document.getElementById('chart_div_<%= segment.unique_id %>'));
    chart.draw(data, options);
  }
</script>

<!-- Google Maps -->
<script type="text/javascript">
  function initialize() {
    <% if geocoded_address.present? %>
      var center_lat_lng = new google.maps.LatLng(<%= geocoded_address.geometry["location"]["lat"] %>, <%= geocoded_address.geometry["location"]["lng"] %>);
    <% else %>
      var center_lat_lng = new google.maps.LatLng(<%= segment.listings.first.latitude %>, <%= segment.listings.first.longitude %>);
    <% end %>
    var mapOptions = {
      scrollwheel: false,
      center: center_lat_lng,
      zoom: 14,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("map_canvas_<%= segment.unique_id %>"), mapOptions);
    var map_bounds = new google.maps.LatLngBounds(center_lat_lng, center_lat_lng)

    var image = new google.maps.MarkerImage(
      'http://maps.google.com/mapfiles/ms/micons/blue.png',
      new google.maps.Size(32, 32), // size
      new google.maps.Point(0,0), // origin
      new google.maps.Point(16, 32) // anchor
    );

    var shadow = new google.maps.MarkerImage(
      'http://maps.google.com/mapfiles/ms/micons/msmarker.shadow.png',
      new google.maps.Size(59, 32), // size
      new google.maps.Point(0,0), // origin
      new google.maps.Point(16, 32) // anchor
    );

    <% for listing in segment.listings %>
      var pos = new google.maps.LatLng(<%= listing.latitude %>, <%= listing.longitude %>);
      var marker = new google.maps.Marker({
        position: new google.maps.LatLng(<%= listing.latitude %>, <%= listing.longitude %>),
        map: map,
        icon: image,
        shadow: shadow
      });
      map_bounds.extend(pos);
    <% end %>

    <% if geocoded_address.present? %>
      var address_image = new google.maps.MarkerImage(
        'http://maps.google.com/mapfiles/ms/micons/red.png',
        new google.maps.Size(32, 32), // size
        new google.maps.Point(0,0), // origin
        new google.maps.Point(16, 32) // anchor
      );
      var marker = new google.maps.Marker({
        position: center_lat_lng,
        map: map,
        icon: address_image,
        zIndex: 1000,
        shadow: shadow
      });
      map_bounds.extend(pos);
    <% end %>

    map.fitBounds(map_bounds);
  }
  google.maps.event.addDomListener(window, 'load', initialize);
</script>
